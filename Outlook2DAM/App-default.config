<?xml version="1.0" encoding="utf-8" ?>
<configuration>
  <appSettings>
    <!-- ========================================
         AUTENTICAÇÃO MICROSOFT GRAPH
         ======================================== -->
    <!-- Obtenha estas credenciais no Azure Portal: https://portal.azure.com -->
    <!-- Azure Active Directory > App registrations > Nova aplicação -->
    <add key="TenantId" value="00000000-0000-0000-0000-000000000000" />
    <add key="ClientId" value="00000000-0000-0000-0000-000000000000" />
    <add key="ClientSecret" value="YOUR_CLIENT_SECRET_HERE" />

    <!-- ========================================
         CONTAS DE EMAIL MONITORIZADAS
         ======================================== -->
    <!-- Suporta MÚLTIPLOS EMAILS separados por ponto e vírgula (;) -->
    <!-- IMPORTANTE: Apenas estes emails aparecerão no campo <to> do XML e na Base de Dados -->
    <!--
    Exemplos:
      - Um único email:
        <add key="UserEmail" value="email@dominio.com" />

      - Múltiplos emails (processamento em paralelo):
        <add key="UserEmail" value="email1@dominio.com;email2@dominio.com;email3@dominio.com" />

      - Email de contraordenações:
        <add key="UserEmail" value="contraordenacaocomprovativo@cm-caminha.pt" />
    -->
    <add key="UserEmail" value="email@dominio.com" />

    <!-- ========================================
         CONFIGURAÇÕES DO SERVIÇO
         ======================================== -->
    <!-- Pasta base para armazenamento de emails processados (pode ser UNC ou local) -->
    <!-- Exemplos:
         - Pasta de rede (UNC): \\servidor\share\Outlook2DAM
         - Pasta local: C:\Outlook2DAM\Emails
         - Pasta local alternativa: D:\EmailProcessing\Outlook2DAM
    -->
    <add key="TempFolder" value="C:\Outlook2DAM\Emails" />

    <!-- Salvar arquivo .eml original do email (true/false) -->
    <!-- true = salva o email original completo em formato .eml -->
    <!-- false = não salva, economiza espaço em disco -->
    <add key="SaveMimeContent" value="true" />

    <!-- Nome da pasta de entrada a monitorizar (opcional, padrão: "Inbox") -->
    <!-- OPÇÃO 1: Pasta única para todos os emails -->
    <!--   <add key="InboxFolder" value="Inbox" /> -->

    <!-- OPÇÃO 2: Pasta diferente por email (formato: email:pasta;email:pasta) -->
    <!--   Exemplo: -->
    <!--   <add key="InboxFolder" value="email1@domain.com:Contraordenações;email2@domain.com:Inbox" /> -->

    <!-- Se um email não estiver listado aqui, usa "Inbox" por padrão -->
    <!-- Deixe em branco ou "Inbox" para usar Caixa de Entrada para todos -->
    <add key="InboxFolder" value="Inbox" />

    <!-- Nome da pasta para emails processados com sucesso (criada automaticamente no Outlook) -->
    <add key="ProcessedFolder" value="Processados" />

    <!-- Nome da pasta para emails com erro após todas as tentativas (criada automaticamente no Outlook) -->
    <add key="ErrorFolder" value="Errors" />

    <!-- Número máximo de tentativas em caso de erro -->
    <!-- Valores recomendados: 3 a 5 -->
    <add key="MaxRetries" value="3" />

    <!-- Intervalo entre verificações de emails não lidos (em segundos) -->
    <!-- Valores comuns:
         - 30 = Verificação a cada 30 segundos (alta frequência)
         - 60 = Verificação a cada minuto (padrão)
         - 300 = Verificação a cada 5 minutos (baixa frequência)
         - 900 = Verificação a cada 15 minutos
    -->
    <add key="ServiceIntervalSeconds" value="60" />

    <!-- Timeout para testes de conexão (em segundos) -->
    <!-- Tempo máximo de espera ao testar conectividade com Graph API e Base de Dados -->
    <add key="ConnectionTestTimeoutSeconds" value="30" />

    <!-- Número máximo de emails processados por ciclo -->
    <!-- Valores comuns:
         - 1 = Processa 1 email por vez (mais seguro, recomendado para início)
         - 5 = Processa até 5 emails por ciclo
         - 10 = Processa até 10 emails por ciclo (melhor performance)
    -->
    <add key="EmailsPerCycle" value="1" />

    <!-- Filtrar apenas emails não lidos -->
    <!-- true = Processa apenas emails não lidos (padrão, recomendado)
         false = Processa TODOS os emails da pasta (cuidado: pode reprocessar emails já processados!)
    -->
    <add key="ProcessOnlyUnread" value="true" />

    <!-- ========================================
         CONFIGURAÇÕES DE LOG
         ======================================== -->
    <!-- Níveis disponíveis (do mais detalhado ao menos detalhado):
         - Verbose: Tudo (muito detalhado, usar apenas em debug)
         - Debug: Informações de depuração (recomendado para desenvolvimento)
         - Information: Eventos importantes do sistema (recomendado para produção)
         - Warning: Situações anormais não-críticas
         - Error: Erros que impedem o processamento
         - Fatal: Erros críticos que param o serviço
    -->
    <add key="LogLevel" value="Information" />

    <!-- Caminho dos logs (relativo ao executável ou absoluto) -->
    <!-- Exemplos:
         - Relativo: logs (cria pasta "logs" no diretório do executável)
         - Absoluto: C:\Logs\Outlook2DAM
         - UNC: \\servidor\share\Logs\Outlook2DAM
    -->
    <add key="LogPath" value="logs" />

    <!-- Se true, reutiliza arquivo de log. Se false, comprime o anterior e cria novo -->
    <!-- false = Recomendado (mantém histórico comprimido) -->
    <add key="RewriteLog" value="false" />

    <!-- Número de dias para manter logs antigos antes de deletar -->
    <!-- Valores comuns: 7, 15, 30, 60, 90 dias -->
    <add key="LogRetentionDays" value="31" />
  </appSettings>

  <!-- ========================================
       CONFIGURAÇÃO DA BASE DE DADOS
       ======================================== -->
  <!-- O sistema detecta AUTOMATICAMENTE o provider baseado na connection string -->
  <!-- Não é necessário configurar nada além da connection string correta -->

  <connectionStrings>
    <!-- ========================================
         ORACLE DATABASE
         ======================================== -->
    <!-- Descomente e configure uma das opções abaixo -->

    <!-- OPÇÃO 1: Oracle com OraOLEDB (recomendado) -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=OraOLEDB.Oracle;Data Source=SEU_TNS_NAME;User ID=SEU_USUARIO;Password=SUA_SENHA;Persist Security Info=True" />
    -->

    <!-- OPÇÃO 2: Oracle com OraOLEDB e servidor direto (sem TNS) -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=OraOLEDB.Oracle;Data Source=(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=servidor)(PORT=1521))(CONNECT_DATA=(SERVICE_NAME=nome_servico)));User ID=SEU_USUARIO;Password=SUA_SENHA;" />
    -->

    <!-- ========================================
         SQL SERVER
         ======================================== -->

    <!-- OPÇÃO 1: SQL Server com OLEDB (compatibilidade antiga) -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=SQLOLEDB;Data Source=SEU_SERVIDOR;Initial Catalog=outlook_db;User ID=SEU_USUARIO;Password=SUA_SENHA;" />
    -->

    <!-- OPÇÃO 2: SQL Server com Native Client 11.0 (recomendado) -->
    <!-- Requer instalação de: https://www.microsoft.com/en-us/download/details.aspx?id=50402 -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=SQLNCLI11;Server=SEU_SERVIDOR;Database=outlook_db;Uid=SEU_USUARIO;Pwd=SUA_SENHA;" />
    -->

    <!-- OPÇÃO 3: SQL Server com Native Client 11.0 e instância nomeada -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=SQLNCLI11;Server=SEU_SERVIDOR\NOME_INSTANCIA;Database=outlook_db;Uid=SEU_USUARIO;Pwd=SUA_SENHA;" />
    -->

    <!-- OPÇÃO 4: Microsoft OLE DB Driver for SQL Server (mais recente) -->
    <!-- Requer instalação de: https://docs.microsoft.com/en-us/sql/connect/oledb/download-oledb-driver-for-sql-server -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=MSOLEDBSQL;Server=SEU_SERVIDOR;Database=outlook_db;UID=SEU_USUARIO;PWD=SUA_SENHA;TrustServerCertificate=yes;" />
    -->

    <!-- OPÇÃO 5: SQL Server com autenticação Windows (Integrated Security) -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=SQLOLEDB;Data Source=SEU_SERVIDOR;Initial Catalog=outlook_db;Integrated Security=SSPI;" />
    -->

    <!-- OPÇÃO 6: SQL Server com autenticação Windows e Native Client -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=SQLNCLI11;Server=SEU_SERVIDOR;Database=outlook_db;Trusted_Connection=yes;" />
    -->

    <!-- OPÇÃO 7: SQL Server local (localhost) -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=SQLOLEDB;Data Source=localhost;Initial Catalog=outlook_db;User ID=SEU_USUARIO;Password=SUA_SENHA;" />
    -->

    <!-- OPÇÃO 8: SQL Server Express local -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=SQLOLEDB;Data Source=.\SQLEXPRESS;Initial Catalog=outlook_db;User ID=SEU_USUARIO;Password=SUA_SENHA;" />
    -->

    <!-- ========================================
         MICROSOFT ACCESS (para testes)
         ======================================== -->

    <!-- OPÇÃO 1: Access 2010/2013/2016/2019 (.accdb) -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=Microsoft.ACE.OLEDB.12.0;Data Source=C:\Caminho\outlook.accdb;Persist Security Info=False;" />
    -->

    <!-- OPÇÃO 2: Access com senha -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=Microsoft.ACE.OLEDB.12.0;Data Source=C:\Caminho\outlook.accdb;Jet OLEDB:Database Password=SUA_SENHA;" />
    -->

    <!-- OPÇÃO 3: Access antigo (.mdb) -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=Microsoft.Jet.OLEDB.4.0;Data Source=C:\Caminho\outlook.mdb;" />
    -->

    <!-- ========================================
         MYSQL (experimental - via OLEDB)
         ======================================== -->
    <!-- Requer instalação do MySQL Connector/ODBC -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=MSDASQL;Driver={MySQL ODBC 8.0 Unicode Driver};Server=SEU_SERVIDOR;Database=outlook_db;User=SEU_USUARIO;Password=SUA_SENHA;" />
    -->

    <!-- ========================================
         POSTGRESQL (experimental - via OLEDB)
         ======================================== -->
    <!-- Requer instalação do PostgreSQL ODBC Driver -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=MSDASQL;Driver={PostgreSQL Unicode};Server=SEU_SERVIDOR;Port=5432;Database=outlook_db;Uid=SEU_USUARIO;Pwd=SUA_SENHA;" />
    -->
  </connectionStrings>

  <!-- ========================================
       INSTRUÇÕES DE USO
       ======================================== -->
  <!--
  ═══════════════════════════════════════════════════════════════════════════════
  PASSO 1: CONFIGURAR AZURE AD (Microsoft Graph)
  ═══════════════════════════════════════════════════════════════════════════════

  1. Aceda ao Azure Portal: https://portal.azure.com
  2. Navegue até: Azure Active Directory > App registrations
  3. Clique em "New registration"
  4. Configure:
     - Name: Outlook2DAM
     - Supported account types: Single tenant
  5. Após criação, copie:
     - Application (client) ID → ClientId
     - Directory (tenant) ID → TenantId
  6. Vá em "Certificates & secrets" > "New client secret"
     - Copie o Value → ClientSecret
  7. Em "API permissions", adicione:
     - Microsoft Graph > Application permissions:
       • Mail.Read
       • Mail.ReadWrite
       • MailboxSettings.Read
     - Clique em "Grant admin consent"

  ═══════════════════════════════════════════════════════════════════════════════
  PASSO 2: CRIAR BASE DE DADOS
  ═══════════════════════════════════════════════════════════════════════════════

  --- ORACLE ---
  CREATE TABLE outlook (
      chave           VARCHAR2(255) PRIMARY KEY,
      remetente       VARCHAR2(255),
      data            DATE,
      hora            NUMBER,
      destinatario    VARCHAR2(1000),
      assunto         VARCHAR2(500),
      caminho_ficheiro VARCHAR2(1000),
      processado      VARCHAR2(1),
      tipodoc         VARCHAR2(50),
      chavedoc        VARCHAR2(255),
      observacoes     CLOB
  );

  --- SQL SERVER ---
  CREATE TABLE outlook (
      chave           NVARCHAR(255) PRIMARY KEY,
      remetente       NVARCHAR(255),
      data            DATE,
      hora            INT,
      destinatario    NVARCHAR(1000),
      assunto         NVARCHAR(500),
      caminho_ficheiro NVARCHAR(1000),
      processado      NVARCHAR(1),
      tipodoc         NVARCHAR(50),
      chavedoc        NVARCHAR(255),
      observacoes     NVARCHAR(MAX)
  );

  ═══════════════════════════════════════════════════════════════════════════════
  PASSO 3: CONFIGURAR ESTE ARQUIVO
  ═══════════════════════════════════════════════════════════════════════════════

  1. Copie este arquivo para: App.config
  2. Preencha as credenciais do Azure AD (TenantId, ClientId, ClientSecret)
  3. Configure UserEmail com o(s) email(s) a monitorar
  4. Configure TempFolder (pasta para armazenar emails)
  5. Descomente UMA opção de connectionString (Oracle ou SQL Server)
  6. Preencha os dados da connection string escolhida

  ═══════════════════════════════════════════════════════════════════════════════
  PASSO 4: INSTALAR COMO SERVIÇO WINDOWS
  ═══════════════════════════════════════════════════════════════════════════════

  # Abrir PowerShell como Administrador

  # Compilar para Release
  dotnet publish -c Release -o C:\Outlook2DAM

  # Copiar App.config configurado
  copy App.config C:\Outlook2DAM\

  # Criar serviço Windows
  sc.exe create "Outlook2DAM" binpath= "C:\Outlook2DAM\Outlook2DAM.exe --cli" start= auto
  sc.exe description "Outlook2DAM" "Processamento automatizado de emails via Microsoft Graph"

  # Iniciar serviço
  sc.exe start "Outlook2DAM"

  # Verificar logs
  Get-Content C:\Outlook2DAM\logs\outlook2dam-*.log -Wait -Tail 50

  ═══════════════════════════════════════════════════════════════════════════════
  NOTAS IMPORTANTES
  ═══════════════════════════════════════════════════════════════════════════════

  ✓ FILTRAGEM DE DESTINATÁRIOS:
    - O campo <to> no XML contém APENAS emails configurados em "UserEmail"
    - Destinatários externos são automaticamente removidos
    - Exemplo:
      UserEmail = "email1@domain.com;email2@domain.com"
      Email recebido em: To: email1@domain.com, email2@domain.com, externo@gmail.com
      XML gerado: <to>email1@domain.com;email2@domain.com</to>

  ✓ DETECÇÃO AUTOMÁTICA DE DATABASE:
    - Oracle: detectado por "Provider=OraOLEDB" ou "oracle"
    - SQL Server: detectado por "SQLOLEDB", "SQLNCLI", "MSOLEDBSQL"
    - Access: detectado por "Microsoft.ACE.OLEDB" ou "Microsoft.Jet.OLEDB"
    - As queries SQL são adaptadas automaticamente para cada provider

  ✓ ESTRUTURA DE PASTAS GERADA:
    TempFolder\
    └── YYYYMMDD_HHMMSS_[ID]\
        ├── [ID].eml             (se SaveMimeContent=true)
        ├── email.pdf            (corpo do email)
        ├── email.xml            (metadados estruturados)
        ├── anexo1.pdf
        ├── anexo2.docx
        └── anexoN.xlsx

  ✓ LOGS:
    - Localizados em: [DiretórioInstalação]\logs\
    - Formato: outlook2dam-YYYYMMDD.log
    - Rotação automática diária
    - Ver logs em tempo real:
      Get-Content C:\Outlook2DAM\logs\outlook2dam-*.log -Wait -Tail 50

  ✓ COMANDOS ÚTEIS:
    # Parar serviço
    sc.exe stop "Outlook2DAM"

    # Ver status
    sc.exe query "Outlook2DAM"

    # Remover serviço
    sc.exe delete "Outlook2DAM"

    # Testar conexão BD e Graph API
    Outlook2DAM.exe --test-connections

  ═══════════════════════════════════════════════════════════════════════════════
  SUPORTE E DOCUMENTAÇÃO
  ═══════════════════════════════════════════════════════════════════════════════

  📖 Documentação completa: README.md
  🐛 Reportar problemas: [Sistema interno de tickets]
  📧 Suporte: suporte@empresa.com

  Versão: 1.1.0
  Última atualização: 2025-01-30
  -->
</configuration>