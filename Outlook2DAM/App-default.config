<?xml version="1.0" encoding="utf-8" ?>
<configuration>
  <appSettings>
    <!-- ========================================
         AUTENTICAÃ‡ÃƒO MICROSOFT GRAPH
         ======================================== -->
    <!-- Obtenha estas credenciais no Azure Portal: https://portal.azure.com -->
    <!-- Azure Active Directory > App registrations > Nova aplicaÃ§Ã£o -->
    <add key="TenantId" value="00000000-0000-0000-0000-000000000000" />
    <add key="ClientId" value="00000000-0000-0000-0000-000000000000" />
    <add key="ClientSecret" value="YOUR_CLIENT_SECRET_HERE" />

    <!-- ========================================
         CONTAS DE EMAIL MONITORIZADAS
         ======================================== -->
    <!-- Suporta MÃšLTIPLOS EMAILS separados por ponto e vÃ­rgula (;) -->
    <!-- IMPORTANTE: Apenas estes emails aparecerÃ£o no campo <to> do XML e na Base de Dados -->
    <!--
    Exemplos:
      - Um Ãºnico email:
        <add key="UserEmail" value="email@dominio.com" />

      - MÃºltiplos emails (processamento em paralelo):
        <add key="UserEmail" value="email1@dominio.com;email2@dominio.com;email3@dominio.com" />

      - Email de contraordenaÃ§Ãµes:
        <add key="UserEmail" value="contraordenacaocomprovativo@cm-caminha.pt" />
    -->
    <add key="UserEmail" value="email@dominio.com" />

    <!-- ========================================
         CONFIGURAÃ‡Ã•ES DO SERVIÃ‡O
         ======================================== -->
    <!-- Pasta base para armazenamento de emails processados (pode ser UNC ou local) -->
    <!-- Exemplos:
         - Pasta de rede (UNC): \\servidor\share\Outlook2DAM
         - Pasta local: C:\Outlook2DAM\Emails
         - Pasta local alternativa: D:\EmailProcessing\Outlook2DAM
    -->
    <add key="TempFolder" value="C:\Outlook2DAM\Emails" />

    <!-- Salvar arquivo .eml original do email (true/false) -->
    <!-- true = salva o email original completo em formato .eml -->
    <!-- false = nÃ£o salva, economiza espaÃ§o em disco -->
    <add key="SaveMimeContent" value="true" />

    <!-- Nome da pasta de entrada a monitorizar (opcional, padrÃ£o: "Inbox") -->
    <!-- OPÃ‡ÃƒO 1: Pasta Ãºnica para todos os emails -->
    <!--   <add key="InboxFolder" value="Inbox" /> -->

    <!-- OPÃ‡ÃƒO 2: Pasta diferente por email (formato: email:pasta;email:pasta) -->
    <!--   Exemplo: -->
    <!--   <add key="InboxFolder" value="email1@domain.com:ContraordenaÃ§Ãµes;email2@domain.com:Inbox" /> -->

    <!-- Se um email nÃ£o estiver listado aqui, usa "Inbox" por padrÃ£o -->
    <!-- Deixe em branco ou "Inbox" para usar Caixa de Entrada para todos -->
    <add key="InboxFolder" value="Inbox" />

    <!-- Nome da pasta para emails processados com sucesso (criada automaticamente no Outlook) -->
    <add key="ProcessedFolder" value="Processados" />

    <!-- Nome da pasta para emails com erro apÃ³s todas as tentativas (criada automaticamente no Outlook) -->
    <add key="ErrorFolder" value="Errors" />

    <!-- NÃºmero mÃ¡ximo de tentativas em caso de erro -->
    <!-- Valores recomendados: 3 a 5 -->
    <add key="MaxRetries" value="3" />

    <!-- Intervalo entre verificaÃ§Ãµes de emails nÃ£o lidos (em segundos) -->
    <!-- Valores comuns:
         - 30 = VerificaÃ§Ã£o a cada 30 segundos (alta frequÃªncia)
         - 60 = VerificaÃ§Ã£o a cada minuto (padrÃ£o)
         - 300 = VerificaÃ§Ã£o a cada 5 minutos (baixa frequÃªncia)
         - 900 = VerificaÃ§Ã£o a cada 15 minutos
    -->
    <add key="ServiceIntervalSeconds" value="60" />

    <!-- Timeout para testes de conexÃ£o (em segundos) -->
    <!-- Tempo mÃ¡ximo de espera ao testar conectividade com Graph API e Base de Dados -->
    <add key="ConnectionTestTimeoutSeconds" value="30" />

    <!-- NÃºmero mÃ¡ximo de emails processados por ciclo -->
    <!-- Valores comuns:
         - 1 = Processa 1 email por vez (mais seguro, recomendado para inÃ­cio)
         - 5 = Processa atÃ© 5 emails por ciclo
         - 10 = Processa atÃ© 10 emails por ciclo (melhor performance)
    -->
    <add key="EmailsPerCycle" value="1" />

    <!-- Filtrar apenas emails nÃ£o lidos -->
    <!-- true = Processa apenas emails nÃ£o lidos (padrÃ£o, recomendado)
         false = Processa TODOS os emails da pasta (cuidado: pode reprocessar emails jÃ¡ processados!)
    -->
    <add key="ProcessOnlyUnread" value="true" />

    <!-- ========================================
         CONFIGURAÃ‡Ã•ES DE LOG
         ======================================== -->
    <!-- NÃ­veis disponÃ­veis (do mais detalhado ao menos detalhado):
         - Verbose: Tudo (muito detalhado, usar apenas em debug)
         - Debug: InformaÃ§Ãµes de depuraÃ§Ã£o (recomendado para desenvolvimento)
         - Information: Eventos importantes do sistema (recomendado para produÃ§Ã£o)
         - Warning: SituaÃ§Ãµes anormais nÃ£o-crÃ­ticas
         - Error: Erros que impedem o processamento
         - Fatal: Erros crÃ­ticos que param o serviÃ§o
    -->
    <add key="LogLevel" value="Information" />

    <!-- Caminho dos logs (relativo ao executÃ¡vel ou absoluto) -->
    <!-- Exemplos:
         - Relativo: logs (cria pasta "logs" no diretÃ³rio do executÃ¡vel)
         - Absoluto: C:\Logs\Outlook2DAM
         - UNC: \\servidor\share\Logs\Outlook2DAM
    -->
    <add key="LogPath" value="logs" />

    <!-- Se true, reutiliza arquivo de log. Se false, comprime o anterior e cria novo -->
    <!-- false = Recomendado (mantÃ©m histÃ³rico comprimido) -->
    <add key="RewriteLog" value="false" />

    <!-- NÃºmero de dias para manter logs antigos antes de deletar -->
    <!-- Valores comuns: 7, 15, 30, 60, 90 dias -->
    <add key="LogRetentionDays" value="31" />
  </appSettings>

  <!-- ========================================
       CONFIGURAÃ‡ÃƒO DA BASE DE DADOS
       ======================================== -->
  <!-- O sistema detecta AUTOMATICAMENTE o provider baseado na connection string -->
  <!-- NÃ£o Ã© necessÃ¡rio configurar nada alÃ©m da connection string correta -->

  <connectionStrings>
    <!-- ========================================
         ORACLE DATABASE
         ======================================== -->
    <!-- Descomente e configure uma das opÃ§Ãµes abaixo -->

    <!-- OPÃ‡ÃƒO 1: Oracle com OraOLEDB (recomendado) -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=OraOLEDB.Oracle;Data Source=SEU_TNS_NAME;User ID=SEU_USUARIO;Password=SUA_SENHA;Persist Security Info=True" />
    -->

    <!-- OPÃ‡ÃƒO 2: Oracle com OraOLEDB e servidor direto (sem TNS) -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=OraOLEDB.Oracle;Data Source=(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=servidor)(PORT=1521))(CONNECT_DATA=(SERVICE_NAME=nome_servico)));User ID=SEU_USUARIO;Password=SUA_SENHA;" />
    -->

    <!-- ========================================
         SQL SERVER
         ======================================== -->

    <!-- OPÃ‡ÃƒO 1: SQL Server com OLEDB (compatibilidade antiga) -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=SQLOLEDB;Data Source=SEU_SERVIDOR;Initial Catalog=outlook_db;User ID=SEU_USUARIO;Password=SUA_SENHA;" />
    -->

    <!-- OPÃ‡ÃƒO 2: SQL Server com Native Client 11.0 (recomendado) -->
    <!-- Requer instalaÃ§Ã£o de: https://www.microsoft.com/en-us/download/details.aspx?id=50402 -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=SQLNCLI11;Server=SEU_SERVIDOR;Database=outlook_db;Uid=SEU_USUARIO;Pwd=SUA_SENHA;" />
    -->

    <!-- OPÃ‡ÃƒO 3: SQL Server com Native Client 11.0 e instÃ¢ncia nomeada -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=SQLNCLI11;Server=SEU_SERVIDOR\NOME_INSTANCIA;Database=outlook_db;Uid=SEU_USUARIO;Pwd=SUA_SENHA;" />
    -->

    <!-- OPÃ‡ÃƒO 4: Microsoft OLE DB Driver for SQL Server (mais recente) -->
    <!-- Requer instalaÃ§Ã£o de: https://docs.microsoft.com/en-us/sql/connect/oledb/download-oledb-driver-for-sql-server -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=MSOLEDBSQL;Server=SEU_SERVIDOR;Database=outlook_db;UID=SEU_USUARIO;PWD=SUA_SENHA;TrustServerCertificate=yes;" />
    -->

    <!-- OPÃ‡ÃƒO 5: SQL Server com autenticaÃ§Ã£o Windows (Integrated Security) -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=SQLOLEDB;Data Source=SEU_SERVIDOR;Initial Catalog=outlook_db;Integrated Security=SSPI;" />
    -->

    <!-- OPÃ‡ÃƒO 6: SQL Server com autenticaÃ§Ã£o Windows e Native Client -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=SQLNCLI11;Server=SEU_SERVIDOR;Database=outlook_db;Trusted_Connection=yes;" />
    -->

    <!-- OPÃ‡ÃƒO 7: SQL Server local (localhost) -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=SQLOLEDB;Data Source=localhost;Initial Catalog=outlook_db;User ID=SEU_USUARIO;Password=SUA_SENHA;" />
    -->

    <!-- OPÃ‡ÃƒO 8: SQL Server Express local -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=SQLOLEDB;Data Source=.\SQLEXPRESS;Initial Catalog=outlook_db;User ID=SEU_USUARIO;Password=SUA_SENHA;" />
    -->

    <!-- ========================================
         MICROSOFT ACCESS (para testes)
         ======================================== -->

    <!-- OPÃ‡ÃƒO 1: Access 2010/2013/2016/2019 (.accdb) -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=Microsoft.ACE.OLEDB.12.0;Data Source=C:\Caminho\outlook.accdb;Persist Security Info=False;" />
    -->

    <!-- OPÃ‡ÃƒO 2: Access com senha -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=Microsoft.ACE.OLEDB.12.0;Data Source=C:\Caminho\outlook.accdb;Jet OLEDB:Database Password=SUA_SENHA;" />
    -->

    <!-- OPÃ‡ÃƒO 3: Access antigo (.mdb) -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=Microsoft.Jet.OLEDB.4.0;Data Source=C:\Caminho\outlook.mdb;" />
    -->

    <!-- ========================================
         MYSQL (experimental - via OLEDB)
         ======================================== -->
    <!-- Requer instalaÃ§Ã£o do MySQL Connector/ODBC -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=MSDASQL;Driver={MySQL ODBC 8.0 Unicode Driver};Server=SEU_SERVIDOR;Database=outlook_db;User=SEU_USUARIO;Password=SUA_SENHA;" />
    -->

    <!-- ========================================
         POSTGRESQL (experimental - via OLEDB)
         ======================================== -->
    <!-- Requer instalaÃ§Ã£o do PostgreSQL ODBC Driver -->
    <!--
    <add name="Outlook2DAM"
         connectionString="Provider=MSDASQL;Driver={PostgreSQL Unicode};Server=SEU_SERVIDOR;Port=5432;Database=outlook_db;Uid=SEU_USUARIO;Pwd=SUA_SENHA;" />
    -->
  </connectionStrings>

  <!-- ========================================
       INSTRUÃ‡Ã•ES DE USO
       ======================================== -->
  <!--
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PASSO 1: CONFIGURAR AZURE AD (Microsoft Graph)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  1. Aceda ao Azure Portal: https://portal.azure.com
  2. Navegue atÃ©: Azure Active Directory > App registrations
  3. Clique em "New registration"
  4. Configure:
     - Name: Outlook2DAM
     - Supported account types: Single tenant
  5. ApÃ³s criaÃ§Ã£o, copie:
     - Application (client) ID â†’ ClientId
     - Directory (tenant) ID â†’ TenantId
  6. VÃ¡ em "Certificates & secrets" > "New client secret"
     - Copie o Value â†’ ClientSecret
  7. Em "API permissions", adicione:
     - Microsoft Graph > Application permissions:
       â€¢ Mail.Read
       â€¢ Mail.ReadWrite
       â€¢ MailboxSettings.Read
     - Clique em "Grant admin consent"

  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PASSO 2: CRIAR BASE DE DADOS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  --- ORACLE ---
  CREATE TABLE outlook (
      chave           VARCHAR2(255) PRIMARY KEY,
      remetente       VARCHAR2(255),
      data            DATE,
      hora            NUMBER,
      destinatario    VARCHAR2(1000),
      assunto         VARCHAR2(500),
      caminho_ficheiro VARCHAR2(1000),
      processado      VARCHAR2(1),
      tipodoc         VARCHAR2(50),
      chavedoc        VARCHAR2(255),
      observacoes     CLOB
  );

  --- SQL SERVER ---
  CREATE TABLE outlook (
      chave           NVARCHAR(255) PRIMARY KEY,
      remetente       NVARCHAR(255),
      data            DATE,
      hora            INT,
      destinatario    NVARCHAR(1000),
      assunto         NVARCHAR(500),
      caminho_ficheiro NVARCHAR(1000),
      processado      NVARCHAR(1),
      tipodoc         NVARCHAR(50),
      chavedoc        NVARCHAR(255),
      observacoes     NVARCHAR(MAX)
  );

  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PASSO 3: CONFIGURAR ESTE ARQUIVO
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  1. Copie este arquivo para: App.config
  2. Preencha as credenciais do Azure AD (TenantId, ClientId, ClientSecret)
  3. Configure UserEmail com o(s) email(s) a monitorar
  4. Configure TempFolder (pasta para armazenar emails)
  5. Descomente UMA opÃ§Ã£o de connectionString (Oracle ou SQL Server)
  6. Preencha os dados da connection string escolhida

  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PASSO 4: INSTALAR COMO SERVIÃ‡O WINDOWS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # Abrir PowerShell como Administrador

  # Compilar para Release
  dotnet publish -c Release -o C:\Outlook2DAM

  # Copiar App.config configurado
  copy App.config C:\Outlook2DAM\

  # Criar serviÃ§o Windows
  sc.exe create "Outlook2DAM" binpath= "C:\Outlook2DAM\Outlook2DAM.exe --cli" start= auto
  sc.exe description "Outlook2DAM" "Processamento automatizado de emails via Microsoft Graph"

  # Iniciar serviÃ§o
  sc.exe start "Outlook2DAM"

  # Verificar logs
  Get-Content C:\Outlook2DAM\logs\outlook2dam-*.log -Wait -Tail 50

  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  NOTAS IMPORTANTES
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  âœ“ FILTRAGEM DE DESTINATÃRIOS:
    - O campo <to> no XML contÃ©m APENAS emails configurados em "UserEmail"
    - DestinatÃ¡rios externos sÃ£o automaticamente removidos
    - Exemplo:
      UserEmail = "email1@domain.com;email2@domain.com"
      Email recebido em: To: email1@domain.com, email2@domain.com, externo@gmail.com
      XML gerado: <to>email1@domain.com;email2@domain.com</to>

  âœ“ DETECÃ‡ÃƒO AUTOMÃTICA DE DATABASE:
    - Oracle: detectado por "Provider=OraOLEDB" ou "oracle"
    - SQL Server: detectado por "SQLOLEDB", "SQLNCLI", "MSOLEDBSQL"
    - Access: detectado por "Microsoft.ACE.OLEDB" ou "Microsoft.Jet.OLEDB"
    - As queries SQL sÃ£o adaptadas automaticamente para cada provider

  âœ“ ESTRUTURA DE PASTAS GERADA:
    TempFolder\
    â””â”€â”€ YYYYMMDD_HHMMSS_[ID]\
        â”œâ”€â”€ [ID].eml             (se SaveMimeContent=true)
        â”œâ”€â”€ email.pdf            (corpo do email)
        â”œâ”€â”€ email.xml            (metadados estruturados)
        â”œâ”€â”€ anexo1.pdf
        â”œâ”€â”€ anexo2.docx
        â””â”€â”€ anexoN.xlsx

  âœ“ LOGS:
    - Localizados em: [DiretÃ³rioInstalaÃ§Ã£o]\logs\
    - Formato: outlook2dam-YYYYMMDD.log
    - RotaÃ§Ã£o automÃ¡tica diÃ¡ria
    - Ver logs em tempo real:
      Get-Content C:\Outlook2DAM\logs\outlook2dam-*.log -Wait -Tail 50

  âœ“ COMANDOS ÃšTEIS:
    # Parar serviÃ§o
    sc.exe stop "Outlook2DAM"

    # Ver status
    sc.exe query "Outlook2DAM"

    # Remover serviÃ§o
    sc.exe delete "Outlook2DAM"

    # Testar conexÃ£o BD e Graph API
    Outlook2DAM.exe --test-connections

  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  SUPORTE E DOCUMENTAÃ‡ÃƒO
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ğŸ“– DocumentaÃ§Ã£o completa: README.md
  ğŸ› Reportar problemas: [Sistema interno de tickets]
  ğŸ“§ Suporte: suporte@empresa.com

  VersÃ£o: 1.1.0
  Ãšltima atualizaÃ§Ã£o: 2025-01-30
  -->
</configuration>